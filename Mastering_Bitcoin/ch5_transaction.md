# Mastering Bitcoin (by 안드레아스 M.안토노풀로스)

#### 블록체인 코어 개발 스터디 5주차 (5/4)
---
# 5장 : 거래

## 들어가기
비트코인에서 거래를 제외한 다른 모든 요소들은 거래가 생성되고 네트워크상에서 전파된 후 승인되어 최종적으로 전 세계에 걸친 거래장부(블록체인)에 거래가 추가될 수 있도록 설계되었다. 거래란 비트코인 시스템 내에 있는 참가자들 간 가치를 전송하는 행위를 인코딩한 데이터 구조를 말한다. 앞서서 거래는 네트워크가 없는 곳에서도 생성할 수 있다고 했는데 생성은 아무때나 하더라도 결국은 네트워크에 전송되어서 다른 참여자들에게 승인을 받고 블록체인에 포함되기 위해서는 한번은 네트워크에 연결되어야 한다.

## 거래의 수명주기
거래의 수명주기는 거래가 생성되는 단계부터 시작한다. 생성된 거래에서 해당 거래가 참조하는 금액을 소비하기 위해서는 승인을 의미하는 서명을 한 건 이상 받아야 한다(앞선 거래의 출력값이 다음 거래의 입력값이 되기 때문에 - 내가 돈을 소비하기 위해서는 그 전에 먼저 돈을 벌어야겠지 - 내가 지금 사용하려고 하는 돈이 나에게 귀속된 것이라는 것을 증명하기 위한 서명을 해야 한다. 그런데 한 건 이상 받아야 한다고 하는 것은 아마 입력값이 하나의 출력값이 아니라 여러 출력값을 모아서 사용하는 경우를 뜻하는 것인 것 같다). 거래를 생성하고 이를 네트워크에 알리면 각 네트워크 노드들이 해당 거래를 검증하고 다른 노드들이 이 거래를 전달받을 수 있도록 계속해서 전파한다(P2P).  마지막으로 해당 거래가 채굴 노드에 의해서 검증된 후 블록체인에 기록되고 그 다음 생성되는 블록들에 의해 확인을 받게 된다(채굴 노드에 의해 검증받는 것이랑 블록에 기록되고 나서 그 다음 블록에 의해 확인/승인을 받는 것은 어떻게 진행되는 것인지?). 이후 해당 거래는 비트코인 장부에 영구적으로 기록되며 모든 참가자들에 의해 유효하다고 인정받는다.

### 거래 생성하기
거래가 생성되었다고 해서 바로 돈이 송금되는 것이 아니고 오히려 check처럼 내가 누구에게 얼마를 전달할 것이라는 의사표현만 한 정도이기 때문에 거래 생성은 말했듯이 온오프라인 모두에서 할 수 있고, 심지어 내가 아닌 다른 사람(지급계정 관리 직원)이 대신 할 수도 있다. 거래를 생성하고 나면 입력값의 소유주(들)가 해당 거래에 서명을 해야 하고 이로써 거래가 완전히 생성되어 유효화된다. 해당 거래가 네트워크에 전송되어 모든 노드들에게 전파되기만 하면 된다.  

### 비트코인 네트워크에 거래 전송하기
비트코인 거래는 별 게 아니라 거래에 대한 정보를 담고 있는 300~400바이트 크기의 데이터이다. 거래는 네트워크 전송 전에 이미 서명을 받았고(해당 돈이 내꺼라는 확인 절차) 데이터 안에 기밀 정보나 개인키, 인증서 같은 정보가 없기 때문에 어떠한 네트워크를 통해서라도 공개적으로 전송할 수 있다. 또한, P2P 방식으로 전체 노드에 거래 내역이 퍼지기 때문에 전송자와 수신자 사이에 신뢰가 필요하지도 않다.  

### 비트코인 네트워크로 거래 전파하기
비트코인 거래가 비트코인 네트워크에 연결된 한 노드에 전송되면 해당 노드에 의해 거래가 유효화된다(?). 거래가 유효화되면 전체 네트워크에 전파되고 유효화되지 못한 경우라면 해당 노드는 승인을 거부하고 동시에 거절 메시지가 생성자에게 돌아간다 (유효화는 어떻게 하는거지? 첫 노드에서 무엇인가를 검사하는 건가?).   

## 거래 구조
거래는 입력값이라고 불리는 자금원으로부터 출력값으로 불리는 목적지까지 가치의 전송을 인코딩하는 **데이터 구조**이다.

## 거래 출력값과 입력값
UTXO는 블록을 구성하는 기본 요소로, 아직 소비되지 않은 거래 출력값을 나타낸다. 내가 어떤 돈을 쓸 수 있다는 것은 이전에 내가 누군가로부터 돈을 받았다는 것을 의미한다. 마찬가지로 비트코인을 소비하기 위해서는 이전 거래에서 내가 누군가로부터 일정 금액의 비트코인을 전달받았고 아직 소비하지 않았어야 한다. 지갑은 비트코인 네트워크에 있는 수많은 UTXO 중에서 나에게 속해 있는 것들만 골라서 보여주는 것이다. (비트코인은 계좌나 잔액이 존재하지 않는다. 블록체인에 흩어져 있는 UTXO만이 존재할 뿐이다.)

거래가 소비하는 UTXO(내가 원래 가지고 있던)를 입력값이라고 하고 거래가 생성하는(이번 거래로 누군가에게 비트코인이 전달될테니까) UTXO를 거래 출력값이라고 한다. 거래 내에서 현 소유주의 서명으로 UTXO의 암호를 풀어서 UTXO를 소비하고 새로운 소유주의 비트코인 주소로 UTXO를 잠가서 새로운 UTXO를 생성한다. 즉, UTXO를 소비하기 위해서는 이게 내 돈이라는 것을 서명으로 증명할 수 있어야 한다. 나 아니면 못 쓰도록 잠가놓고, 내가 사용하고 싶을 때 암호를 푸는 과정은 스크립트로 작성된다.

### 거래 출력값
거래 출력값은 UTXO와 잠금 스크립트로 구성된다. 모든 비트코인 거래는 출력값을 생성하고, OP_RETURN의 경우를 제외하면 UTXO를 생성한다. 잠금 스크립트는 출력값을 나중에 소비하기 위해서 충족되어야 하는 조건을 명시하여 아무나 사용하지 못하도록 잠가두는 역할을 한다.

### 거래 입력값
거래 입력값은 UTXO에 대한 포인터 역할을 한다. 즉, 내가 이번 거래에서 네트워크 상의 수많은 UTXO 중에서 어떤 것을 사용할 것인지 거래 해시와 일련번호를 사용하여 UTXO를 지정한다. 이전 거래의 출력값이 이번 거래의 입력값이 되기 때문에 입력값에는 잠금 스크립트를 풀 수 있는 조건을 만족하는 해제 스크립트도 포함되어야 한다. **해제 스크립트는 보통 잠금 스크립트 내에 있는 비트코인 주소의 소유권을 입증하는 서명이다.** 

소비하고자 하는 금액에 맞게 UTXO가 선택되면 지갑에서는 UTXO 각각을 위한 서명을 담고 있는 해제 스크립트를 생성한다. 

### 거래 수수료
대부분의 지갑에서는 거래 수수료는 자동으로 계산하여 그 값을 거래에 포함한다. 하지만 경우에 따라서는 수동으로 계산하여 포함해야 하는 경우도 있다. 거래 수수료는 거래 가치보다는 킬로바이트 단위의 거래 크기를 근거로 계산된다. 계산식이 정해진 것이 아니라 네트워크 내의 시장의 힘에 따라 수수료가 결정된다. 

### 거래에 수수료 추가하기
거래에 수수료 필드가 따로 있는 것이 아니라, 입력값 총합에서 출력값 총합을 제하고 남은 초과량이 수수료이다. 주의할 점은 나의 UTXO가 이번 거래에서 내가 소비할 가치보다 크다면 거스름돈으로 내가 다시 돌려받을 금액까지 거래 내용에 포함해야 한다는 것이다. 그렇지 않으면 그 차액 만큼이 모두 수수료로 돌아가게 될 것이다. 

## 거래 사슬과 고아거래
때에 따라서는 서로 연결되어 있는 거래 사슬들이 동시에 생성될 수도 있다. 부모 거래, 자식 거래 손자 거래가 동시에 생성될 수도 있다는 말이다 (어떤 상황에서 이런 거래가 생길지? -> 프라이버시 보호를 위해 여러 명의 참가자가 함께 거래에 참여하는 코인조인 거래에 사용되는 기법)

거래 사슬이 항상 차례대로 네트워크에 도착하는 것은 아니다. 이런 경우에 조금만 기다리면 유효한 부모 거래가 도착할텐데 자식 거래가 도착한 시점에서 유효하지 않다고 이를 폐기하는 것은 비효율적이다. 이런 문제를 해결하기 위해서 고아거래 풀을 만들어서 부모 거래가 없는 아이들을 보관한다. 고아거래 풀을 사용함으로써 거래의 도착 순서에 상관없이 모든 거래가 올바른 순서로 재구성될 수 있다.  

## 거래 스크립트와 스크립트 언어
### 스크립트 구성
비트코인 거래에는 두가지 종류의 스크립트가 사용된다. 잠금 스크립트와 해제 스크립트가 그것이다. 

잠금 스크립트는 출력값에 포함되어 있고, 향후 이 출력값을 소비하기 위해서 충족되어야 하는 조건이 명시되어 있다. 잠금 스크립트에는 보통 공개키나 비트코인 주소가 포함되어 있어서 scriptPubKey로 불린다. 해제 스크립트는 잠금 스크립트의 조건을 충족시켜 출력값을 소비할 수 있게 하는 스크립트이다. 해제 스크립트는 입력값에 포함되어 있고, 보통 사용자의 지갑이 개인키로부터 생성한 디지털 서명이 들어 있다. 

비트코인 클라이언트는 잠금 스크립트와 해제 스크립트를 동시에 실행해서 거래를 유효화시킨다. 먼저 입력값이 참조한 UTXO를 검색한다. UTXO는 잠금 스크립트를 포함하고 있을 것이고, 그러면 입력값에 들어있는 해제 스크립트를 사용해서 해당 잠금 스크립트의 암호를 풀게 된다. 

## 표준 거래
### Pay-to-Public-Key-Hash(P2PKH)
이 거래에는 공개키 해시(비트코인 주소)를 이용한 잠금 스크립트가 포함되어 있다. P2PKH 스크립트로 잠겨있는 출력값은 **공개키와 개인키가 생성한 디지털 서명**이 있어야 해제할 수 있다. 

### Pay-to-Public-Key
P2PK는 P2HKH보다 좀 더 단순한 방식으로, 공개키가 잠금 스크립트 내에 자체적으로 저장되어 있어 길이가 훨씬 짧아지게 된다. (P2PKH에는 공개키의 해시가 저장된다). 

### 다중서명
다중서명은 N개의 공개키가 스크립트에 기록되어 있고 잠금 스크립트를 풀기 위해서 M개 이상의 개인키가 서명을 제공해야 한다는 조건을 설정한다. 

### 데이터 출력(OP_RETURN)
비트코인 지불과 관련이 없는 데이터를 저장하기 위해서 블록체인을 사용하는 경우를 위해 OP_RETURN 연산자를 도입하였다. 출력값에 OP_RETURN을 주면 해당 UTXO는 절대 소비될 수 없는 것으로 이해되고, UTXO 세트에 포함되지도 않게 된다.

### Pay-to-Script-Hash(P2SH)
P2SH는 복잡한 거래 스크립트를 단순화시킨 방식으로, 해당 출력값이 소비된 후에 제공되며 해시와 일치하는 스크립트로 지불하는 방식이다. P2SH는 복잡한 잠금 스크립트를 암호 해시인 디지털 지문으로 대체한다. P2SH 거래에서 해시로 대체되는 잠금 스크립트를 Redeem Script라고 한다. 리딤 스크립트는 종전처럼 여러 공개키를 포함한 굉장히 긴 스크립트이고, 출력값에 포함되는 잠금 스크립트에는 이 리딤 스크립트를 해쉬화한 짧은 값을 포함하여 결과적으로 거래 데이터가 커지는 것을 방지한다. 그리고 해제 스크립트에는 해당 리딤 스크립트가 포함되어 있어야 끝까지 인증하고 소비할 수 있게 되겠지?
