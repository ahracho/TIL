# Mastering Bitcoin (by 안드레아스 M.안토노풀로스)

#### 블록체인 코어 개발 스터디 6주차 (5/11 - 불참)
---
# 6장 : 비트코인 네트워크

## P2P 네트워크 아키텍쳐
비트코인 네트워크의 주요 원리는 분산화된 통제이며, 이는 동등하고 분산화된 P2P 합의 네트워크 상에서만 시행되고 유지될 수 있다. 비트코인 네트워크는 비트코인 P2P 프로토콜을 실행하는 노드의 집합이다. 

## 노드의 유형 및 역할
P2P 네트워크 상의 노드들이 동등한 지위를 가진하고 해도 기능에 따라서 각자 하는 역할은 다르다. 비트코인 노드는 라우팅, 블록체인 DB, 채굴, 지갑 서비스 등 4개의 기능으로 나눌 수 있다. 

모든 노드는 네트워크 내에 라우팅 기능을 가지고 있다. 즉, 모든 노드는 거래와 블록을 검증하고 전파하며, 이웃 노드들과의 연결을 유지하는 기능을 한다. 풀 노드는 가장 최신의 블록체인 복사본을 가지고 있어 외부 참조 없이도 독자적으로 어떠한 거래든 검증할 수 있다. 어떤 노드는 풀 노드(풀 블록체인)를, 어떤 노드는 블록체인의 일부(SPV 노드 또는 라이트웨이트 노드)만을 가지고 있다. 채굴 노드는 작업 증명 알고리즘을 풀어 새로운 블록을 생성하기 위해 경쟁한다. 채굴 노드 역시 풀 노드를 가지고 있을 수도 있고, 일부만 가지고 풀 서버에 의존할 수도 있다. 

## 확장 비트코인 네트워크
확장 비트코인 네트워크에는 비트코인 P2P 프로토콜로 가동하는 네트워크 뿐만 아니라 특수한 프로토콜을 가동하는 노도도 포함되어 있다. 메인 비트코인 P2P 네트워크에는 수많은 풀 서버와 기타 프로토콜로 가동되는 노드들을 연결하는 프로토콜 게이트웨이가 붙어 있다. 이런 프로토콜 노드들은 보통 블록체인 전체의 복사본을 가지고 있지는 않다.

## 네트워크 검색
새로운 노드를 작동시킬 때 반드시 네트워크 상에 존재하는 다른 비트코인 노드들을 검색해야만 한다(기존 네트워크에 내 노드도 연결해야 하니까).  

포트 8333번을 열어서 TCP 커넥션을 맺으면 나와 상대는 일련의 과정으로 메시지를 교환하여 상대에게 연결 요청을 승인받는다. 그럼 처음에 어떻게 상대 노드 (이웃 노드)를 검색할 수 있었던 걸까? 오랫동안 안정되게 동작하고 있는 종자 노드들이 클라이언트 목록에 기록되어 있는데, 새로운 노드는 이 종자노드를 사용해서 빠르게 네트워크 내 다른 노드를 검색할 수 있다. 종자 노드가 없는 경우에는 하나 이상의 비트코인 노드 IP 주소가 필요하다. 종자노드를 통해 이웃 노드를 검색하게 되면 해당 클라이언트는 종자 노드와의 연결을 끊고 새로 검색된 이웃 노드와 연결된다. 

연결이 성립되면 새로운 노드는 이웃 노드들에게 자신의 IP 주소가 담겨있는 메시지를 보내고, 이 메시지를 받은 이웃 노드들이 다시 자신의 이웃 노드들에게 전파하게 된다.

## 인벤토리 교환하기
새로 생성된 풀 노드가 이웃 노드들에 연결되고 나서 가장 먼저 하는 일은 완전한 블록체인을 만드는 것이다. 새로 생성되었기 때문에 초기 상태에서는 최초블록 #0 밖에 없는 상태에서 풀 블록체인을 다운로드 해야 한다. 

블록체인을 동기화하는 프로세스는 version 메시지로 시작한다. version 메시지에는 노드의 현재 블록체인 높이를 알 수 있는 BestHeight 값이 담겨있어, 이웃들로부터 이 값을 받아서 본인의 값과 비교할 수 있다. 이웃 노드들끼리 본인 로컬 블록체인의 제일 위에 있는 블록의 해시 값을 담아 getblocks 메시지를 교환하여 비교한다. 해시값을 보면 상대의 블록이 자신의 것보다 최신 것인지 아닌지를 판별할 수 있게 된다. 

길이가 좀 더 긴 블록체인을 가지고 있는 노드가 이웃 노드에게 어떤 블록이 더 필요한지 확인한 다음, inv 메시지를 이용해서 해시를 공유하고 전송하기 위한 첫 500 블록을 확인한다. 해당 블록을 가지고 있지 않은 노드는 getdata 메시지를 보내서 이웃 노드에게 해당 블록을 가져올 수 있다. 

## 단순지불검증(SPV) 노드
풀 블록체인은 용량이 엄청나기 때문에 모든 노드가 풀 블록체인을 다운받지는 않는다. 특히 모바일에서는 단순지불검증 방법을 이용해서 일부만 저장하고도 운영될 수 있도록 한다. 이런 클라이언트를 SPV 클라이언트 또는 라이트웨이트 클라이언트라고 한다. 

SPV 클라이언트는 블록 헤더만 다운로드하고 각 블록에 속해 있는 실제 거래들은 다운로드 하지 않는다. SPV 노드는 거래 전체를 다 알지 못하기 때문에 UTXO 전부에 대해서도 알지도 못한다. 그래서 SPV 노드는 다른 방법을 이용해 거래를 검증한다.  

단순지불검증은 블록체인 내에서 해당 블록의 높이가 아닌 깊이를 기준으로 거래를 검증한다. 풀 블록체인 노드가 최초블록까지 연결된 모든 블록과 거래를 검증하여 체인을 생성한다면, SPV 노드는 모든 **블록(not 거래)**의 체인을 검증하고 확인하고자 하는 거래를 체인에 연결하는 방식을 사용한다. 

SPV 노드는 거래에서 사용하려는 UTXO의 소비 여부는 판별할 수 없으나 머클 경로를 이용해서 해당 거래와 그 거래가 담겨 있는 블록을 연결한다. 그 후, 해당 블록 위에 6개의 블록이 쌓였는지 확인하고 블록의 깊이가 6이 되면 해당 거래가 문제 없다고 검증한다. 그 위에 6개의 블록이 쌓였다는 것은 해당 거래가 이중지불 거래가 아니었다는 것을 반증하기 때문이다. 


## 블룸필터
## 블룸필터 및 인벤토리 업데이트
## 거래 풀
## 비상 메시지